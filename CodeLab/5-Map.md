# Google Maps
# Pre-requisite
This section requires a valid Google account and Google Maps app installed on your device.


## Accessing Google Cloud Console
> There is a simple way to enable Google Maps directly. Just visit https://console.developers.google.com/flows/enableapi?apiid=maps_android_backend and select the project that you want to use Google Maps

1. Go to https://cloud.google.com/

2. Login or signup for a Google account if you have not.

3. At the top right side of the website, click on "Console" beside your profile picture.

4. If you have multiple project, you can switch your project at the dropdown on the top left in the AppBar. Select the *Pasar Malam Locator* project that you had created in Firebase Console.

5. Click on the hamburger menu (3 lines) at the top left to open the side navigation drawer  
  ![Cloud Console](https://github.com/AgmoStudioSdnBhd/Android-Pasar-Malam-Locator/raw/master/art/side_nav.jpg)

6. Click on the 2nd item **API MANAGER**

7. At the side menu of API MANAGER, click on the 2nd item **Library**  
  ![Enable Maps](https://github.com/AgmoStudioSdnBhd/Android-Pasar-Malam-Locator/raw/master/art/maps_api.jpg)

8. Look for "*Google Maps Android API*" and click it.

9. Click "Enable" at the top.

## Google Maps in your app
1. Start by adding the Google Play Services Maps library in your `app/build.gradle` dependencies.  
*Note: Google Play Services is a large library. It is recommended to only include specific library feature into your app. In this section we are only interested in maps. At the time of writing, the latest Google Play Services library is v9.4.0. Refer* https://developers.google.com/android/guides/setup

  ```java
  dependencies {
      // ...
      compile 'com.google.android.gms:play-services-maps:9.4.0'
  }
  ```
2. Right click on the `java` folder in `/app/src/main`

3. Select **New** -> **Fragment** -> **Fragment (Blank)**

4. In the popup dialog, change the *Fragment Name* field to "GoogleMapsFragment". Uncheck "*Include fragment factory methods?*" and also "*Include interface callbacks?*"  
  **Note**: If you accidentally chose the wrong Fragment or did not uncheck, just delete all the code in the class that was generated except `onCreateView()` method.

6. Open `fragment_google_maps.xml` in the layout folder

7. Replace the existing `TextView` with a `fragment`
  ```xml
  <FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
      xmlns:app="http://schemas.android.com/apk/res-auto"
      xmlns:tools="http://schemas.android.com/tools"
      android:layout_width="match_parent"
      android:layout_height="match_parent"
      tools:context="com.agmostudio.pasarmalamlocator.GoogleMapsFragment">

      <fragment
          android:id="@+id/map"
          class="com.google.android.gms.maps.SupportMapFragment"
          android:layout_width="match_parent"
          android:layout_height="match_parent"
          app:useViewLifecycle="true" />

  </FrameLayout>

  ```
8. Open `AndroidManifest.xml` file in `app/src/main` directory

9. Add the Google API key within the `<application>` tag.  
Note: Although we didnt define `@string/google_api_key`, it was generated by the Google Services Gradle plugin when we added in `google-services.json`. Inside the file, it declared the `"api_key"`
  ```xml
  <application ...>
      // ...
      <meta-data
          android:name="com.google.android.geo.API_KEY"
          android:value="@string/google_api_key" />

  </application>
  ```

10. Open back the `GoogleMapsFragment.java`

11. Make the `GoogleMapsFragment` to implement `OnMapReadyCallback`
  ```java
  public class GoogleMapsFragment extends Fragment implements OnMapReadyCallback {

      GoogleMap map;

      @Nullable
      @Override
      public View onCreateView(LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) {
          return inflater.inflate(R.layout.fragment_google_maps, container, false);
      }

      @Override
      public void onViewCreated(View view, @Nullable Bundle savedInstanceState) {
          super.onViewCreated(view, savedInstanceState);
          SupportMapFragment mapFragment = (SupportMapFragment) getChildFragmentManager()
                  .findFragmentById(R.id.map);
          mapFragment.getMapAsync(this);
      }

      @Override
      public void onMapReady(GoogleMap googleMap) {
          map = googleMap;
      }
  }
  ```
10. In your `MainActivity.java`, in the `MyPagerAdapter`, change the `getItem()`

  ```java
  @Override
  public Fragment getItem(int position) {
      if (position == 0) return new NearbyFragment();
      else return new GoogleMapsFragment();
  }
  ```

11. Build and run the app.

## Adding Pins to Map

1. In `GoogleMapsFragment`, inside `onMapReady` method. Get the data from Firebase and create pin. At the same time, build the boundaries of the map.
  ```java
  @Override
  public void onMapReady(GoogleMap googleMap) {
      map = googleMap;

      FirebaseDatabase database = FirebaseDatabase.getInstance();
      DatabaseReference table = database.getReference("pasarmalam");
      table.addValueEventListener(new ValueEventListener() {
          @Override
          public void onDataChange(DataSnapshot dataSnapshot) {
              LatLngBounds.Builder bounds = new LatLngBounds.Builder();
              for (DataSnapshot snapshot : dataSnapshot.getChildren()) {
                  PasarMalam pasarMalam = snapshot.getValue(PasarMalam.class);

                  LatLng latLng = new LatLng(pasarMalam.latitude, pasarMalam.longitude);
                  bounds.include(latLng);

                  Marker marker = map.addMarker(
                          new MarkerOptions()
                                  .title(pasarMalam.name)
                                  .position(latLng));
                  marker.setTag(pasarMalam);
              }

              map.moveCamera(CameraUpdateFactory.newLatLngBounds(bounds.build(), 0));
          }

          @Override
          public void onCancelled(DatabaseError error) {
              error.toException().printStackTrace();
          }
      });
  }
  ```
